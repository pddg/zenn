---
title: "データベースを使う"
---

## Webアプリケーションとデータ

多くのWebアプリケーションはユーザから何らかの入力を受け取り、保存しています。例えばユーザ名・パスワードのようなものから、そのサービス特有のデータまで様々な物を取り扱います。

もしアプリケーションのメモリ内のみにそのデータがある場合、単にプロセスを再起動するだけでそのデータは失われてしまいます[^inmem]。このようなシステムのメンテナンスは著しく困難です。

[^inmem]: Redisやその互換インメモリKVSであるDragonflyはメモリ内にデータを保存しますが、レプリケーションをサポートすることで複数インスタンスのメモリ上に同じデータが存在するように設定できます（[ref](https://redis.io/docs/management/replication/), [ref](https://redis.io/docs/management/replication/)）。これにより、サービスメンテナンス時にもデータを失わずに済みます。このようなレプリケーションの実装は一般に難しく、アプリケーションが自前で実装することは避けるべきです。

ローカルファイルシステムへのデータの永続化も可能ですが、そのファイルシステムへの複数のVM・物理マシンからの同時アクセスは一般に困難です。NFSやSambaなどを用いてネットワーク経由で共有ディスクをマウントすれば複数のプロセスが同じデータへアクセス出来るようになりますが、整合性の問題を引き起こす可能性があります[^nfsinprod]。

[^nfsinprod]: 例えばSQLiteデータベースをNFS上に配置し、複数のプロセスが同時に書き込むと整合性に問題が発生します（[ref](https://www.sqlite.org/faq.html#q5)）。NFSの実装ではファイルロックを正しく扱えないことに起因しており、SQLiteを使わず独自にデータストアを実装する場合でも複数のプロセス間でどのようにロックを取るかを考慮する必要があります。そのような実装は一般に難しく、アプリケーションが自前で実装することは避けるべきです。

そのため多くのWebアプリケーションはデータの保存に専用のミドルウェアを用いています。最も一般的なのはリレーショナルデータベースシステム（RDBMS）です。RDBMSはデータの永続化だけでなく、データの整合性を保つためのトランザクション機構や、データの検索を高速化するためのインデックス機構を提供しています。またメンテナンスや負荷分散・障害対策の観点からデータのレプリケーション機能を提供することもあります。
本書ではRDBMSの1つであるMySQLをとりあげ、MySQLを用いるサンプル実装を通じてデータベースを使う際の注意点やデータベースを冗長化する方法を説明します。

## サンプルのTODOアプリケーション

本書では筆者が実装した以下のアプリケーションを用います。

@[card](https://github.com/pddg/go-sample-todo)

このアプリケーションは以下の様な機能を持っています。

- `GET /todo`
  - 登録されたTODOを全て取得する
  - 例：`curl localhost:8080/todo`
- `POST /todo`
  - 新しいTODOを登録する
  - 例：`curl -X POST -d '{"task":"new todo"}' localhost:8080/todo`
- `DELETE /todo/:id`
  - 指定したIDのTODOを削除する
  - 例：`curl -X DELETE localhost:8080/todo/1`
- `POST /initialize`
  - データベースを初期化する
  - 例：`curl -X POST localhost:8080/initialize`

このアプリケーションはin memoryモードと、MySQLを使った永続化のいずれかのモードで動作します。in memoryモードではデータはメモリ内にのみ保存され、プロセスを再起動するとデータが失われます。MySQLモードではデータはMySQLデータベースに保存され、プロセスを再起動してもデータは失われません。
